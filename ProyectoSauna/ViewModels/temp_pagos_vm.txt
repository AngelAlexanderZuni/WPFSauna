using ProyectoSauna.Commands;
using ProyectoSauna.Models.DTOs;
using ProyectoSauna.Services.Interfaces;
using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Input;

namespace ProyectoSauna.ViewModels
{
    public class PagosViewModel : BaseViewModel
    {
        private readonly IPagoService _pagoService;
        private readonly IMetodoPagoService _metodoPagoService;

        public event Action? PagoCreado;

        public ObservableCollection<PagoDTO> Pagos { get; } = new();
        public ObservableCollection<MetodoPagoDTO> MetodosPago { get; } = new();

        private int _idCuenta;
        public int IdCuenta { get => _idCuenta; set { _idCuenta = value; OnPropertyChanged(); } }

        // Formulario
        public int IdMetodoPago { get; set; }
        public decimal Monto { get; set; }
        public string? NumeroReferencia { get; set; }
        public DateTime FechaHora { get; set; } = DateTime.Now;

        // UI State
        private bool _isDialogOpen;
        public bool IsDialogOpen { get => _isDialogOpen; set { _isDialogOpen = value; OnPropertyChanged(); } }

        // Totales
        private decimal _totalPagos;
        public decimal TotalPagos { get => _totalPagos; set { _totalPagos = value; OnPropertyChanged(); } }

        // Commands
        public ICommand CargarMetodosCommand { get; }
        public ICommand CargarPagosCommand { get; }
        public ICommand AbrirDialogCommand { get; }
        public ICommand CerrarDialogCommand { get; }
        public ICommand ConfirmarPagoCommand { get; }
        public ICommand LimpiarFormCommand { get; }

        public PagosViewModel(IPagoService pagoService, IMetodoPagoService metodoPagoService)
        {
            _pagoService = pagoService;
            _metodoPagoService = metodoPagoService;

            CargarMetodosCommand = new AsyncRelayCommand(async _ => await CargarMetodosAsync());
            CargarPagosCommand = new AsyncRelayCommand(async _ => await CargarPagosAsync());
            AbrirDialogCommand = new RelayCommand(() => IsDialogOpen = true);
            CerrarDialogCommand = new RelayCommand(() => IsDialogOpen = false);
            ConfirmarPagoCommand = new AsyncRelayCommand(async _ => await ConfirmarPagoAsync());
            LimpiarFormCommand = new RelayCommand(() => LimpiarForm());

            _ = InicializarAsync();
        }

        private async Task InicializarAsync()
        {
            await CargarMetodosAsync();
        }

        private async Task CargarMetodosAsync()
        {
            var lista = await _metodoPagoService.GetMetodosAsync();
            MetodosPago.Clear();
            foreach (var m in lista) MetodosPago.Add(m);
        }

        public async Task CargarPagosAsync()
        {
            if (IdCuenta <= 0) { Pagos.Clear(); TotalPagos = 0; return; }
            var lista = await _pagoService.GetPagosPorCuentaAsync(IdCuenta);
            Pagos.Clear();
            foreach (var p in lista) Pagos.Add(p);
            RecalcularTotal();
        }

        private async Task ConfirmarPagoAsync()
        {
            if (IdCuenta <= 0 || IdMetodoPago <= 0 || Monto <= 0) return;
            var dto = new PagoDTO
            {
                idCuenta = IdCuenta,
                idMetodoPago = IdMetodoPago,
                monto = Monto,
                numeroReferencia = string.IsNullOrWhiteSpace(NumeroReferencia) ? null : NumeroReferencia?.Trim(),
                fechaHora = FechaHora == default ? DateTime.Now : FechaHora
            };
            var res = await _pagoService.CrearPagoAsync(dto);
            if (res.exito)
            {
                await CargarPagosAsync();
                PagoCreado?.Invoke();
                IsDialogOpen = false;
                LimpiarForm();
            }
        }

        private void LimpiarForm()
        {
            IdMetodoPago = 0; Monto = 0; NumeroReferencia = null; FechaHora = DateTime.Now;
            OnPropertyChanged(nameof(IdMetodoPago));
            OnPropertyChanged(nameof(Monto));
            OnPropertyChanged(nameof(NumeroReferencia));
            OnPropertyChanged(nameof(FechaHora));
        }

        private void RecalcularTotal()
        {
            TotalPagos = Pagos.Sum(x => x.monto);
        }
    }
}
